<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>ArcherSense - Prototype V3</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1" rel="stylesheet"/>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#74b814",
                        "background-dark": "#1a2111",
                        "surface-dark": "#262e1c",
                        "error": "#ef4444"
                    },
                    fontFamily: { "display": ["Lexend", "sans-serif"] },
                },
            },
        }
    </script>

    <style>
        body { font-family: 'Lexend', sans-serif; overflow: hidden; background-color: #1a2111; color: white; }
        .screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; flex-direction: column; overflow-y: auto; }
        .screen.active { display: flex; }
        /* Overlay & Video styling */
        .camera-wrapper { position: relative; flex: 1; background: black; display: flex; justify-content: center; overflow: hidden; }
        .input_video { position: absolute; top:0; left:0; width: 100%; height: 100%; object-fit: cover; opacity: 0; }
        .output_canvas { position: relative; z-index: 10; height: 100%; width: auto; object-fit: cover; }
        #success-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(116,184,20,0.3); z-index: 50; display: none; pointer-events: none; }
    </style>
</head>

<body class="h-screen w-screen selection:bg-primary selection:text-white">

    <div id="success-overlay"></div>

    <section id="screen-welcome" class="screen active p-6 justify-center items-center text-center">
        <div class="mb-6 size-24 rounded-full bg-surface-dark border-2 border-primary flex items-center justify-center">
            <span class="material-symbols-outlined text-primary text-6xl">target</span>
        </div>
        <h1 class="text-4xl font-bold mb-2">Archer<span class="text-primary">Sense</span></h1>
        <p class="text-gray-400 mb-8">Dein Coach für zu Hause.</p>
        <button onclick="goToOnboarding()" class="w-full max-w-sm py-4 bg-primary text-background-dark font-bold rounded-xl hover:brightness-110 transition">
            Starten
        </button>
    </section>

    <section id="screen-calibration" class="screen p-6">
        <div class="flex items-center mb-6">
            <button onclick="showScreen('welcome')" class="mr-4 material-symbols-outlined">arrow_back</button>
            <h2 class="text-xl font-bold">Kalibrierung (Seitenprofil)</h2>
        </div>

        <div class="flex flex-col gap-4 max-w-sm mx-auto w-full pb-20">
            <div class="bg-surface-dark p-4 rounded-xl border border-white/10">
                <h3 class="font-bold text-primary mb-1">1. Neutraler Stand</h3>
                <p class="text-xs text-gray-400 mb-2">Arme locker hängend. Wirbelsäule gerade.</p>
                <input type="file" id="input-stand" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-primary/20 file:text-primary"/>
                <p id="res-stand" class="mt-2 text-xs text-green-400 font-mono"></p>
            </div>

            <div class="bg-surface-dark p-4 rounded-xl border border-white/10">
                <h3 class="font-bold text-primary mb-1">2. Setup (T-Pose)</h3>
                <p class="text-xs text-gray-400 mb-2">Arme gehoben, Blick zum Ziel.</p>
                <input type="file" id="input-setup" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-primary/20 file:text-primary"/>
                <p id="res-setup" class="mt-2 text-xs text-green-400 font-mono"></p>
            </div>

            <div class="bg-surface-dark p-4 rounded-xl border border-white/10">
                <h3 class="font-bold text-primary mb-1">3. Vollauszug (Anker)</h3>
                <p class="text-xs text-gray-400 mb-2">Hand am Gesicht, Ellenbogen hinten.</p>
                <input type="file" id="input-draw" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-primary/20 file:text-primary"/>
                <p id="res-draw" class="mt-2 text-xs text-green-400 font-mono"></p>
            </div>

            <button id="btn-finish-calib" disabled onclick="finishCalibration()" class="w-full py-4 bg-primary disabled:opacity-50 text-background-dark font-bold rounded-xl mt-2">
                Kalibrierung Speichern
            </button>
            <img id="img-processor" style="display:none;" />
        </div>
    </section>

    <section id="screen-home" class="screen bg-background-dark">
        <div class="p-6">
            <h2 class="text-2xl font-bold mb-1">Hallo, Alex</h2>
            <p class="text-xs text-gray-400 mb-6">Nächste Einheit wartet.</p>

            <div class="bg-surface-dark rounded-2xl p-5 border border-primary/20 relative overflow-hidden mb-6">
                <h3 class="text-lg font-bold mb-1">Tägliches Training</h3>
                <p class="text-sm text-gray-400 mb-4">Übung: <span class="text-primary">Stand & Balance</span></p>
                <button onclick="startTrainingFlow()" class="w-full py-3 bg-primary text-background-dark font-bold rounded-xl flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">play_arrow</span> Starten
                </button>
            </div>
            
            <div class="grid grid-cols-3 gap-2">
                 <button onclick="setLevel(1)" class="p-2 bg-surface-dark rounded border border-white/10 text-xs">Level 1: Stand</button>
                 <button onclick="setLevel(2)" class="p-2 bg-surface-dark rounded border border-white/10 text-xs">Level 2: Setup</button>
                 <button onclick="setLevel(4)" class="p-2 bg-surface-dark rounded border border-white/10 text-xs">Level 4: Auszug</button>
            </div>
        </div>
    </section>

    <section id="screen-safety" class="screen p-6 justify-center items-center text-center bg-red-900/10">
        <span class="material-symbols-outlined text-error text-6xl mb-4">warning</span>
        <h2 class="text-2xl font-bold text-white mb-2">Sicherheit</h2>
        <div class="bg-surface-dark p-4 rounded-xl border border-error/50 mb-8 max-w-sm text-left">
            <p class="text-sm text-gray-300">⚠️ <strong>Niemals trockenfeuern!</strong><br>Nutze ein Gummiband oder ziehe den Bogen nur aus, ohne zu lösen.</p>
        </div>
        <button onclick="confirmSafety()" class="w-full max-w-sm py-4 bg-white text-black font-bold rounded-xl">Verstanden</button>
    </section>

    <section id="screen-live" class="screen bg-black">
        <div class="camera-wrapper">
            <video class="input_video" playsinline autoplay muted></video>
            <canvas class="output_canvas"></canvas>
            
            <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-start bg-gradient-to-b from-black/80 to-transparent">
                <div>
                    <div class="text-xs text-gray-400">WIEDERHOLUNGEN</div>
                    <div class="text-4xl font-mono font-bold text-white" id="rep-counter">0<span class="text-lg text-gray-500">/5</span></div>
                </div>
                
                <div class="flex flex-col items-end gap-2">
                    <div class="px-4 py-2 bg-surface-dark/90 border border-primary text-primary text-sm font-bold rounded-lg shadow-lg flex items-center gap-2 backdrop-blur-md">
                        <span class="material-symbols-outlined text-base">visibility</span>
                        <div class="flex flex-col text-right">
                            <span class="text-[10px] text-gray-400 uppercase leading-none">Fokus</span>
                            <span id="focus-text" class="leading-none">STAND</span>
                        </div>
                    </div>
                    
                    <button onclick="stopTraining()" class="size-10 rounded-full bg-white/10 flex items-center justify-center text-white mt-2">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 w-full p-6 bg-gradient-to-t from-black/90 to-transparent text-center">
                <div id="debug-text" class="text-sm text-gray-400 mb-1 font-mono">Suche Pose...</div>
                <div class="w-full h-2 bg-gray-700 rounded-full overflow-hidden">
                    <div id="prox-bar" class="h-full bg-primary w-0 transition-all duration-100"></div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // STATE
        const appState = {
            screen: 'welcome',
            calib: { stand: null, setup: null, draw: null },
            training: { level: 1, reps: 0, maxReps: 5, holdingSince: 0, isActive: false }
        };

        const EXERCISES = {
            1: { name: "Stand", focus: "GERADE HÜFTE", ref: "stand" },
            2: { name: "Setup", focus: "ARM HÖHE", ref: "setup" },
            3: { name: "Auszug", focus: "ANKER", ref: "draw" },
            4: { name: "Auszug", focus: "ELLENBOGEN", ref: "draw" }
        };

        // DOM HELPER
        const $ = id => document.getElementById(id);
        const screens = document.querySelectorAll('.screen');
        const video = document.querySelector('.input_video');
        const canvas = document.querySelector('.output_canvas');
        const ctx = canvas.getContext('2d');

        // --- NAVIGATION ---
        function showScreen(id) {
            screens.forEach(s => s.classList.remove('active'));
            $(`screen-${id}`).classList.add('active');
        }

        function goToOnboarding() {
            // TTS Warmup beim ersten User-Klick!
            initTTS(); 
            initAudio();
            showScreen('calibration');
        }

        function startTrainingFlow() {
            initTTS(); // Sicherheitshalber nochmal
            showScreen('safety');
            speak("Bitte Sicherheitshinweise beachten.");
        }

        function setLevel(lvl) {
            appState.training.level = lvl;
            startTrainingFlow();
        }

        function confirmSafety() {
            showScreen('live');
            startLiveSession();
        }

        function stopTraining() {
            appState.training.isActive = false;
            updateDrone(false);
            showScreen('home');
        }

        // --- CALIBRATION LOGIC (3 IMAGES) ---
        const poseStatic = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        poseStatic.setOptions({modelComplexity: 1});
        poseStatic.onResults(handleCalibResults);

        let calibTarget = '';

        function setupCalibInput(id, target) {
            $(id).addEventListener('change', (e) => {
                calibTarget = target;
                const file = e.target.files[0];
                if(file) {
                    const img = $('img-processor');
                    img.src = URL.createObjectURL(file);
                    img.onload = () => poseStatic.send({image: img});
                }
            });
        }
        setupCalibInput('input-stand', 'stand');
        setupCalibInput('input-setup', 'setup');
        setupCalibInput('input-draw', 'draw');

        function handleCalibResults(results) {
            if(!results.poseLandmarks) return;
            const lm = results.poseLandmarks;
            
            // Vereinfachte Logik: Wir speichern einfach die Landmarks
            // In einer echten App würde man hier Winkel mitteln
            if (calibTarget === 'stand') {
                // Stand: Wir speichern Hüft/Schulter-Verhältnis
                appState.calib.stand = { lm: lm }; 
                $(`res-stand`).innerText = "Stand gespeichert ✓";
            } else if (calibTarget === 'setup') {
                // Setup: Armwinkel
                appState.calib.setup = { 
                    bowArm: calculateAngle(lm[11], lm[13], lm[15]) 
                };
                $(`res-setup`).innerText = "Setup gespeichert ✓";
            } else if (calibTarget === 'draw') {
                // Draw: Armwinkel im Auszug
                appState.calib.draw = { 
                    bowArm: calculateAngle(lm[11], lm[13], lm[15]),
                    elbow: calculateAngle(lm[13], lm[11], lm[12]) // Schulteröffnung
                };
                $(`res-draw`).innerText = "Auszug gespeichert ✓";
            }

            if(appState.calib.stand && appState.calib.setup && appState.calib.draw) {
                $('btn-finish-calib').disabled = false;
            }
        }

        function finishCalibration() { showScreen('home'); }

        // --- LIVE TRAINING ---
        const poseLive = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        poseLive.setOptions({modelComplexity: 1, smoothLandmarks: true});
        poseLive.onResults(onLiveResults);

async function startLiveSession() {
    appState.training.isActive = true;
    updateLiveUI();
    speak("Kamera wird gestartet.");

    try {
        // RADIKAL VEREINFACHT: Keine width/height constraints
        const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: false, // Wichtig: Audio aus, sonst Feedback-Schleife
            video: { 
                facingMode: 'environment' // Das ist der einzige Wunsch: Rückkamera
            } 
        });

        video.srcObject = stream;
        
        // Explizites Play für iOS
        video.onloadedmetadata = () => {
            video.play();
            processLoop(); 
        };

    } catch(e) {
        alert("Kamera-Fehler: " + e.message + "\nVersuche Safari (iOS) oder Chrome (Android).");
    }
}
        async function processLoop() {
            if(appState.training.isActive && video.readyState >= 2) {
                await poseLive.send({image: video});
            }
            if(appState.training.isActive) requestAnimationFrame(processLoop);
        }

        function onLiveResults(results) {
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.drawImage(results.image,0,0,canvas.width,canvas.height);
            
            // Dark Overlay
            ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(0,0,canvas.width,canvas.height);

if(results.poseLandmarks) {
    // 1. Die "Outline" (Schwarz, dicker)
    drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#000000', lineWidth: 6});
    drawLandmarks(ctx, results.poseLandmarks, {color: '#000000', lineWidth: 6});

    // 2. Die "Füllung" (Neon, dünner)
    drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#74b814', lineWidth: 3});
    drawLandmarks(ctx, results.poseLandmarks, {color: '#FFFFFF', lineWidth: 2}); // Punkte weiß
}
        }

        function evaluatePose(lm) {
            const exercise = EXERCISES[appState.training.level] || EXERCISES[1];
            const ref = appState.calib[exercise.ref];
            let isGood = false;
            let diff = 0;

            // Simple Logic Examples
            if (exercise.ref === 'setup' && ref) {
                const currentArm = calculateAngle(lm[11], lm[13], lm[15]);
                diff = Math.abs(currentArm - ref.bowArm);
                isGood = diff < 15;
            } else if (exercise.ref === 'draw' && ref) {
                const currentArm = calculateAngle(lm[11], lm[13], lm[15]);
                diff = Math.abs(currentArm - ref.bowArm);
                isGood = diff < 15;
            } else {
                // Fallback / Stand (Simulation)
                isGood = true; 
            }

            // Feedback Visuals
            const proximity = Math.max(0, 1 - (diff/45));
            $('prox-bar').style.width = `${proximity * 100}%`;
            $('prox-bar').className = `h-full transition-all ${isGood ? 'bg-primary' : 'bg-error'}`;
            $('debug-text').innerText = `Diff: ${diff.toFixed(0)}°`;

            // Feedback Audio
            handleFeedback(isGood, proximity);
        }

        function handleFeedback(isGood, proximity) {
            if (isGood) {
                updateDrone(true, 1.0);
                if (appState.training.holdingSince === 0) appState.training.holdingSince = Date.now();
                
                if (Date.now() - appState.training.holdingSince > 300) {
                    // Success!
                    $('success-overlay').style.display = 'block';
                    setTimeout(() => $('success-overlay').style.display = 'none', 200);
                    appState.training.holdingSince = 0;
                    
                    // Throttle Success Sound
                    if(Date.now() - (window.lastSuccess||0) > 2000) {
                        playSuccess();
                        window.lastSuccess = Date.now();
                        appState.training.reps++;
                        $('rep-counter').innerHTML = `${appState.training.reps}<span class="text-lg text-gray-500">/5</span>`;
                        speak(String(appState.training.reps));
                    }
                }
            } else {
                appState.training.holdingSince = 0;
                updateDrone(true, 0.3);
                // Geigerzähler Logic hier...
            }
        }

        // --- AUDIO & TTS ---
        let drone, polySynth;

        function initTTS() {
            // Trick: Leere Äußerung, um Engine zu wecken
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance("");
                window.speechSynthesis.speak(u);
            }
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'de-DE'; 
                u.rate = 1.1;
                window.speechSynthesis.speak(u);
            }
        }

        function initAudio() {
            if(drone || Tone.context.state === 'running') return;
            Tone.start();
            drone = new Tone.FatOscillator({type: "triangle", frequency: 110, spread: 20, count: 3}).toDestination();
            drone.volume.value = -Infinity;
            drone.start();
            polySynth = new Tone.PolySynth(Tone.Synth).toDestination();
        }

        function updateDrone(active, vol) {
            if(!drone) return;
            drone.volume.rampTo(active ? -30 + (vol*20) : -Infinity, 0.1);
        }

        function playSuccess() {
            if(polySynth) polySynth.triggerAttackRelease(["C5", "E5", "G5"], "8n");
        }

        // --- MATH ---
        function calculateAngle(a, b, c) {
            let rad = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(rad * (180.0 / Math.PI));
            if (angle > 180.0) angle = 360 - angle;
            return angle;
        }
        
        // --- SIMULATION (Key S) ---
        document.addEventListener('keydown', e => {
            if(e.key.toLowerCase() === 's' && appState.training.isActive) {
                 handleFeedback(true, 1.0);
            }
        });
    </script>
</body>
</html>