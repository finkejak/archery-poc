<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>ArcherAI - The Intelligent Home Training Extension</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1" rel="stylesheet"/>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#74b814",
                        "background-dark": "#1a2111",
                        "surface-dark": "#262e1c",
                        "error": "#ef4444"
                    },
                    fontFamily: { "display": ["Lexend", "sans-serif"] },
                },
            },
        }
    </script>

    <style>
        body { font-family: 'Lexend', sans-serif; overflow: hidden; background-color: #1a2111; color: white; }
        .screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; flex-direction: column; overflow-y: auto; }
        .screen.active { display: flex; }
        
        /* Video Fix: Video ist sichtbar, Canvas liegt drüber */
        .camera-wrapper { position: relative; flex: 1; background: black; display: flex; justify-content: center; overflow: hidden; }
        .input_video { position: absolute; top:0; left:0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        .output_canvas { position: relative; z-index: 10; height: 100%; width: auto; object-fit: cover; }
        
        #success-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(116,184,20,0.3); z-index: 50; display: none; pointer-events: none; }

        /* Skeleton Illustration CSS */
        .skeleton-demo { position: relative; width: 100px; height: 150px; border: 2px dashed #444; margin: 0 auto; border-radius: 10px; }
        .sk-head { width: 20px; height: 20px; border: 2px solid #74b814; border-radius: 50%; position: absolute; top: 10px; left: 38px; }
        .sk-spine { width: 2px; height: 60px; background: #74b814; position: absolute; top: 32px; left: 48px; }
        .sk-arm-l { width: 30px; height: 2px; background: #74b814; position: absolute; top: 40px; left: 18px; }
        .sk-arm-r { width: 30px; height: 2px; background: #74b814; position: absolute; top: 40px; left: 50px; }
        .sk-leg-l { width: 2px; height: 50px; background: #74b814; position: absolute; top: 90px; left: 38px; transform: rotate(10deg); }
        .sk-leg-r { width: 2px; height: 50px; background: #74b814; position: absolute; top: 90px; left: 60px; transform: rotate(-10deg); }
    </style>
</head>

<body class="h-screen w-screen selection:bg-primary selection:text-white">

    <div id="success-overlay"></div>

    <section id="screen-welcome" class="screen active p-6 justify-center items-center text-center">
        <div class="mb-6 size-24 rounded-full bg-surface-dark border-2 border-primary flex items-center justify-center">
            <span class="material-symbols-outlined text-primary text-6xl">target</span>
        </div>
        <h1 class="text-4xl font-bold mb-2">Archer<span class="text-primary">AI</span></h1>
        <p class="text-gray-400 mb-8">Die Intelligente Home Training Extension</p>
        <button onclick="startWizard()" class="w-full max-w-sm py-4 bg-primary text-background-dark font-bold rounded-xl hover:brightness-110 transition">
            Starten
        </button>
    </section>

    <section id="screen-wiz-intro" class="screen p-6 justify-center items-center text-center">
        <h2 id="wiz-title" class="text-2xl font-bold mb-4">Schritt 1: Frontal</h2>
        <p id="wiz-desc" class="text-gray-400 mb-6">Stelle dich auf die Schusslinie. Die Kamera sieht dich von vorne/hinten.</p>
        
        <div class="skeleton-demo mb-8 bg-surface-dark">
            <div class="sk-head"></div>
            <div class="sk-spine"></div>
            <div class="sk-arm-l"></div><div class="sk-arm-r"></div>
            <div class="sk-leg-l"></div><div class="sk-leg-r"></div>
        </div>

        <button onclick="nextWizardStep('upload')" class="w-full max-w-sm py-4 bg-primary text-background-dark font-bold rounded-xl">
            Verstanden, weiter
        </button>
    </section>

    <section id="screen-wiz-upload" class="screen p-6 justify-center">
        <div class="flex items-center mb-6">
            <button onclick="prevWizardStep()" class="mr-4 material-symbols-outlined">arrow_back</button>
            <h2 class="text-xl font-bold">Foto aufnehmen</h2>
        </div>
        
        <div class="bg-surface-dark p-6 rounded-xl border border-white/10 text-center">
            <span class="material-symbols-outlined text-4xl text-primary mb-2">photo_camera</span>
            <p class="mb-4 text-sm text-gray-400">Wähle ein Bild oder mache ein Foto.</p>
            <input type="file" id="wiz-input" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-primary/20 file:text-primary"/>
        </div>
        
        <img id="wiz-img-proc" style="display:none;" />
        <div id="wiz-loading" class="hidden mt-4 text-center text-primary animate-pulse">Analysiere Pose...</div>
    </section>

    <section id="screen-wiz-verify" class="screen p-6 justify-center items-center text-center">
        <div class="size-16 rounded-full bg-primary/20 flex items-center justify-center mb-4">
            <span class="material-symbols-outlined text-primary text-3xl">check</span>
        </div>
        <h2 class="text-2xl font-bold mb-2">Pose erkannt!</h2>
        <p id="wiz-result-text" class="text-gray-400 mb-8 font-mono text-sm">Daten wurden gespeichert.</p>
        
        <button onclick="confirmWizardStep()" class="w-full max-w-sm py-4 bg-primary text-background-dark font-bold rounded-xl">
            Bestätigen
        </button>
        <button onclick="prevWizardStep()" class="mt-4 text-gray-500 text-sm">Neues Bild wählen</button>
    </section>

    <section id="screen-home" class="screen bg-background-dark">
        <div class="p-6">
            <h2 class="text-2xl font-bold mb-1">Hallo, Alex</h2>
            <p class="text-xs text-gray-400 mb-6">Nächste Einheit wartet.</p>

            <div class="bg-surface-dark rounded-2xl p-5 border border-primary/20 relative overflow-hidden mb-6">
                <h3 class="text-lg font-bold mb-1">Tägliches Training</h3>
                <p class="text-sm text-gray-400 mb-4">Übung: <span class="text-primary">Stand & Balance</span></p>
                <button onclick="startTrainingFlow()" class="w-full py-3 bg-primary text-background-dark font-bold rounded-xl flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">play_arrow</span> Starten
                </button>
            </div>
            
            <h3 class="font-bold mb-3 text-sm text-gray-500 uppercase">Schnellstart</h3>
            <div class="grid grid-cols-2 gap-3">
                 <button onclick="setLevel(1)" class="p-3 bg-surface-dark rounded-xl border border-white/10 text-sm font-bold text-left hover:border-primary">
                    1. Stand<br><span class="text-xs text-gray-500 font-normal">Frontal</span>
                 </button>
                 <button onclick="setLevel(2)" class="p-3 bg-surface-dark rounded-xl border border-white/10 text-sm font-bold text-left hover:border-primary">
                    2. Setup<br><span class="text-xs text-gray-500 font-normal">Seitlich</span>
                 </button>
                 <button onclick="setLevel(3)" class="p-3 bg-surface-dark rounded-xl border border-white/10 text-sm font-bold text-left hover:border-primary">
                    3. Auszug<br><span class="text-xs text-gray-500 font-normal">Seitlich</span>
                 </button>
            </div>
        </div>
    </section>

    <section id="screen-safety" class="screen p-6 justify-center items-center text-center bg-red-900/10">
        <span class="material-symbols-outlined text-error text-6xl mb-4">warning</span>
        <h2 class="text-2xl font-bold text-white mb-2">Sicherheit</h2>
        <div class="bg-surface-dark p-4 rounded-xl border border-error/50 mb-8 max-w-sm text-left">
            <p class="text-sm text-gray-300">⚠️ <strong>Niemals trockenfeuern!</strong><br>Nutze ein Gummiband oder ziehe den Bogen nur aus, ohne zu lösen.</p>
        </div>
        <button onclick="confirmSafety()" class="w-full max-w-sm py-4 bg-white text-black font-bold rounded-xl">Verstanden</button>
    </section>

    <section id="screen-live" class="screen bg-black">
        <div class="camera-wrapper">
            <video class="input_video" playsinline autoplay muted></video>
            <canvas class="output_canvas"></canvas>
            
            <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-start bg-gradient-to-b from-black/80 to-transparent z-20">
                <div>
                    <div class="text-xs text-gray-400">REPS</div>
                    <div class="text-4xl font-mono font-bold text-white" id="rep-counter">0<span class="text-lg text-gray-500">/5</span></div>
                </div>
                
                <div class="flex flex-col items-end gap-2">
                    <div class="px-4 py-2 bg-surface-dark/90 border border-primary text-primary text-sm font-bold rounded-lg shadow-lg flex items-center gap-2 backdrop-blur-md">
                        <span class="material-symbols-outlined text-base">visibility</span>
                        <div class="flex flex-col text-right">
                            <span class="text-[10px] text-gray-400 uppercase leading-none">Fokus</span>
                            <span id="focus-text" class="leading-none">STAND</span>
                        </div>
                    </div>
                    
                    <button onclick="stopTraining()" class="size-10 rounded-full bg-white/10 flex items-center justify-center text-white mt-2 hover:bg-red-500">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 w-full p-6 bg-gradient-to-t from-black/90 to-transparent text-center z-20">
                <button onclick="restartCamera()" class="text-xs text-gray-500 underline mb-2">Kamera neu starten</button>
                <div id="debug-text" class="text-sm text-gray-400 mb-1 font-mono">Suche Pose...</div>
                <div class="w-full h-2 bg-gray-700 rounded-full overflow-hidden">
                    <div id="prox-bar" class="h-full bg-primary w-0 transition-all duration-100"></div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // --- 1. CONFIG & STATE ---
        const EXERCISES = {
            1: { name: "Stand", focus: "GERADE HÜFTE", ref: "front" },
            2: { name: "Setup", focus: "ARM HÖHE", ref: "side" },
            3: { name: "Auszug", focus: "ANKER", ref: "side" }
        };

        const appState = {
            calib: { front: null, side: null },
            wizard: { step: 'front' }, // 'front' or 'side'
            training: { level: 1, reps: 0, maxReps: 5, holdingSince: 0, isActive: false }
        };

        // DOM Elements
        const $ = id => document.getElementById(id);
        const screens = document.querySelectorAll('.screen');
        const video = document.querySelector('.input_video');
        const canvas = document.querySelector('.output_canvas');
        const ctx = canvas.getContext('2d');

        // --- 2. NAVIGATION & WIZARD ---
        function showScreen(id) {
            screens.forEach(s => s.classList.remove('active'));
            $(`screen-${id}`).classList.add('active');
        }

        function startWizard() {
            // TTS Warmup
            if ('speechSynthesis' in window) window.speechSynthesis.speak(new SpeechSynthesisUtterance(""));
            
            // Reset & Start with Front
            appState.wizard.step = 'front';
            updateWizardUI();
            showScreen('wiz-intro');
        }

        function updateWizardUI() {
            const isFront = appState.wizard.step === 'front';
            $('wiz-title').innerText = isFront ? "Schritt 1: Frontal" : "Schritt 2: Seitlich";
            $('wiz-desc').innerText = isFront 
                ? "Kamera auf der Schusslinie. Wir messen Standbreite." 
                : "Kamera im 90° Winkel (Profil). Wir messen Armwinkel.";
            // Clear inputs
            $('wiz-input').value = "";
        }

        function nextWizardStep(target) {
            showScreen(`wiz-${target}`);
        }

        function prevWizardStep() {
            showScreen('wiz-intro');
        }

        function confirmWizardStep() {
            if(appState.wizard.step === 'front') {
                appState.wizard.step = 'side';
                updateWizardUI();
                showScreen('wiz-intro');
            } else {
                finishCalibration();
            }
        }

        function finishCalibration() {
            // Save to LocalStorage if needed
            showScreen('home');
        }

        // --- 3. CALIBRATION LOGIC ---
        const poseStatic = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        poseStatic.setOptions({modelComplexity: 1});
        poseStatic.onResults(handleWizResults);

        // Setup File Input Listener
        $('wiz-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                $('wiz-loading').classList.remove('hidden');
                const img = $('wiz-img-proc');
                img.src = URL.createObjectURL(file);
                img.onload = () => poseStatic.send({image: img});
            }
        });

        function handleWizResults(results) {
            $('wiz-loading').classList.add('hidden');
            
            if(!results.poseLandmarks) {
                alert("Keine Person erkannt. Bitte versuche es erneut.");
                return;
            }

            const lm = results.poseLandmarks;
            const step = appState.wizard.step;

            if (step === 'front') {
                // Save Front Data (Shoulder/Foot Ratio)
                const shoulderW = Math.abs(lm[11].x - lm[12].x);
                const footW = Math.abs(lm[27].x - lm[28].x);
                const ratio = shoulderW > 0 ? footW / shoulderW : 0.5;
                appState.calib.front = { ratio: ratio };
                $('wiz-result-text').innerText = `Stand-Verhältnis: ${ratio.toFixed(2)}`;
            } else {
                // Save Side Data (Arm Angle)
                const armAngle = calculateAngle(lm[11], lm[13], lm[15]);
                appState.calib.side = { bowArm: armAngle };
                $('wiz-result-text').innerText = `Arm-Winkel: ${armAngle.toFixed(0)}°`;
            }

            showScreen('wiz-verify');
        }

        // --- 4. TRAINING FLOW ---
        function startTrainingFlow() {
            showScreen('safety');
            speak("Bitte Sicherheitshinweise beachten.");
        }

        function setLevel(lvl) {
            appState.training.level = lvl;
            startTrainingFlow();
        }

        function confirmSafety() {
            showScreen('live');
            startLiveSession();
        }

        function stopTraining() {
            appState.training.isActive = false;
            updateDrone(false);
            showScreen('home');
        }

        // --- 5. LIVE CAMERA & LOGIC ---
        const poseLive = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        poseLive.setOptions({modelComplexity: 1, smoothLandmarks: true});
        poseLive.onResults(onLiveResults);

        async function startLiveSession() {
            appState.training.isActive = true;
            appState.training.reps = 0;
            
            const exercise = EXERCISES[appState.training.level] || EXERCISES[1];
            $('focus-text').innerText = exercise.focus;
            speak(`Training gestartet. Fokus: ${exercise.focus}`);
            
            initAudio();
            startCameraStream();
        }

        async function startCameraStream() {
            try {
                // ULTRA BASIC CONSTRAINTS FOR BRAVE/MOBILE
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }, // Keine Width/Height Vorgabe!
                    audio: false 
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    processLoop();
                };
            } catch(e) {
                alert("Kamera-Fehler: " + e.message + "\nPrüfe 'Brave Shields' oder Permissions.");
            }
        }

        function restartCamera() {
            if(video.srcObject) {
                video.srcObject.getTracks().forEach(t => t.stop());
            }
            startCameraStream();
        }

        async function processLoop() {
            if(appState.training.isActive) {
                // Nur senden wenn Video läuft
                if(video.readyState >= 2) {
                    await poseLive.send({image: video});
                }
                requestAnimationFrame(processLoop);
            }
        }

        function onLiveResults(results) {
            // Draw
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            
            // Wenn Video da ist, aber kein Resultat, bleibt Canvas leer (Video sichtbar dahinter)
            // Wir zeichnen nur Overlay
            if(results.poseLandmarks) {
                // High Contrast Style
                drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#000000', lineWidth: 6});
                drawLandmarks(ctx, results.poseLandmarks, {color: '#000000', lineWidth: 6});
                drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#74b814', lineWidth: 3});
                drawLandmarks(ctx, results.poseLandmarks, {color: '#FFFFFF', lineWidth: 2});
                
                // --- KERN LOGIK AUFRUF ---
                evaluatePose(results.poseLandmarks);
            }
        }

        function evaluatePose(lm) {
            const exercise = EXERCISES[appState.training.level];
            let isGood = false;
            let diff = 0;

            if (exercise.ref === 'front' && appState.calib.front) {
                // Compare Front Ratio
                const shoulderW = Math.abs(lm[11].x - lm[12].x);
                const footW = Math.abs(lm[27].x - lm[28].x);
                const currentRatio = shoulderW > 0 ? footW / shoulderW : 0;
                diff = Math.abs(currentRatio - appState.calib.front.ratio);
                isGood = diff < 0.2; // Toleranz
            } 
            else if (exercise.ref === 'side' && appState.calib.side) {
                // Compare Side Arm
                const currentArm = calculateAngle(lm[11], lm[13], lm[15]);
                diff = Math.abs(currentArm - appState.calib.side.bowArm);
                isGood = diff < 15; // 15 Grad Toleranz
            } 
            else {
                // Fallback / Simulation
                isGood = true; 
            }

            // UI Feedback
            const proximity = Math.max(0, 1 - (diff / (exercise.ref==='front'? 0.5 : 45)));
            $('prox-bar').style.width = `${proximity * 100}%`;
            $('prox-bar').className = `h-full transition-all ${isGood ? 'bg-primary' : 'bg-error'}`;
            $('debug-text').innerText = isGood ? "Gute Haltung" : "Korigieren...";

            handleAudioFeedback(isGood, proximity);
        }

        function handleAudioFeedback(isGood, proximity) {
            if (isGood) {
                updateDrone(true, 1.0);
                if (appState.training.holdingSince === 0) appState.training.holdingSince = Date.now();
                
                if (Date.now() - appState.training.holdingSince > 300) {
                    // SUCCESS
                    if(Date.now() - (window.lastSuccess||0) > 2000) {
                        playSuccess();
                        window.lastSuccess = Date.now();
                        appState.training.reps++;
                        $('rep-counter').innerHTML = `${appState.training.reps}<span class="text-lg text-gray-500">/5</span>`;
                        speak(String(appState.training.reps));
                        
                        // Show Overlay briefly
                        $('success-overlay').style.display = 'block';
                        setTimeout(() => $('success-overlay').style.display = 'none', 200);
                    }
                }
            } else {
                appState.training.holdingSince = 0;
                updateDrone(true, 0.3);
                // Geigerzähler Logic optional here
            }
        }

        // --- AUDIO HELPERS ---
        let drone, polySynth;
        
        function initAudio() {
            if(drone || Tone.context.state === 'running') return;
            Tone.start();
            drone = new Tone.FatOscillator({type: "triangle", frequency: 110, spread: 20, count: 3}).toDestination();
            drone.volume.value = -Infinity;
            drone.start();
            polySynth = new Tone.PolySynth(Tone.Synth).toDestination();
        }

        function updateDrone(active, vol) {
            if(!drone) return;
            drone.volume.rampTo(active ? -30 + (vol*20) : -Infinity, 0.1);
        }

        function playSuccess() {
            if(polySynth) polySynth.triggerAttackRelease(["C5", "E5", "G5"], "8n");
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'de-DE'; u.rate = 1.1;
                window.speechSynthesis.speak(u);
            }
        }

        function calculateAngle(a, b, c) {
            let rad = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(rad * (180.0 / Math.PI));
            if (angle > 180.0) angle = 360 - angle;
            return angle;
        }

        // --- SIMULATION (Key S) ---
        document.addEventListener('keydown', e => {
            if(e.key.toLowerCase() === 's' && appState.training.isActive) {
                 handleAudioFeedback(true, 1.0);
            }
        });
    </script>
</body>
</html>