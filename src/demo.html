<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>ArcherAI - Survival Mode</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#74b814", "background-dark": "#1a2111", "surface-dark": "#262e1c", "error": "#ef4444" },
                    fontFamily: { "display": ["Lexend", "sans-serif"] },
                },
            },
        }
    </script>

    <style>
        body { font-family: 'Lexend', sans-serif; overflow: hidden; background-color: #1a2111; color: white; }
        .screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; flex-direction: column; overflow-y: auto; }
        .screen.active { display: flex; }
        
        .camera-wrapper { position: relative; flex: 1; background: black; display: flex; justify-content: center; overflow: hidden; }
        .input_video { position: absolute; top:0; left:0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        .output_canvas { position: relative; z-index: 10; height: 100%; width: auto; object-fit: cover; }
        
        #success-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(116,184,20,0.4); z-index: 50; display: none; pointer-events: none; }
        #fail-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(239,68,68,0.4); z-index: 50; display: none; pointer-events: none; }

        /* Animationen */
        .pulse-text { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
        
        /* Wizard Skeleton */
        .skeleton-demo { position: relative; width: 100px; height: 160px; border: 2px dashed #444; margin: 0 auto; border-radius: 10px; opacity: 0.8; }
        .sk-head { width: 24px; height: 24px; border: 2px solid #74b814; border-radius: 50%; position: absolute; top: 15px; left: 36px; }
        .sk-body { width: 2px; height: 60px; background: #74b814; position: absolute; top: 39px; left: 47px; }
        .sk-arm { width: 60px; height: 2px; background: #74b814; position: absolute; top: 45px; left: 18px; }
        .sk-legs { width: 40px; height: 50px; border-left: 2px solid #74b814; border-right: 2px solid #74b814; border-top: 0; position: absolute; top: 99px; left: 28px; transform: perspective(20px) rotateX(5deg); }
    </style>
</head>

<body class="h-screen w-screen selection:bg-primary selection:text-white">

    <div id="success-overlay"></div>
    <div id="fail-overlay"></div>

    <section id="screen-welcome" class="screen active p-6 justify-center items-center text-center">
        <div class="mb-6 size-24 rounded-full bg-surface-dark border-2 border-primary flex items-center justify-center">
            <span class="material-symbols-outlined text-primary text-6xl">target</span>
        </div>
        <h1 class="text-4xl font-bold mb-2">Archer<span class="text-primary">AI</span></h1>
        <p class="text-gray-400 mb-8">Survival & Form Coach</p>
        <button onclick="startWizard()" class="w-full max-w-sm py-4 bg-primary text-background-dark font-bold rounded-xl hover:brightness-110 transition">
            Starten
        </button>
    </section>

    <section id="screen-wiz-intro" class="screen p-6 justify-center items-center text-center">
        <h2 id="wiz-title" class="text-2xl font-bold mb-4 text-primary">Schritt 1</h2>
        <p id="wiz-desc" class="text-lg text-gray-300 mb-8 leading-relaxed">...</p>
        <div class="skeleton-demo mb-8 bg-surface-dark/50">
            <div class="sk-head"></div><div class="sk-body"></div><div class="sk-arm"></div><div class="sk-legs"></div>
        </div>
        <button onclick="nextWizardStep('upload')" class="w-full max-w-sm py-4 bg-primary text-background-dark font-bold rounded-xl">Alles klar</button>
    </section>

    <section id="screen-wiz-upload" class="screen p-6 justify-center">
        <div class="flex items-center mb-6">
            <button onclick="prevWizardStep()" class="mr-4 material-symbols-outlined">arrow_back</button>
            <h2 class="text-xl font-bold">Aufnahme</h2>
        </div>
        <div class="bg-surface-dark p-8 rounded-xl border border-white/10 text-center flex flex-col gap-4">
            <span class="material-symbols-outlined text-5xl text-primary">add_a_photo</span>
            <p class="text-gray-400">Bild hochladen oder aufnehmen.</p>
            <input type="file" id="wiz-input" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-primary/20 file:text-primary"/>
        </div>
        <img id="wiz-img-proc" style="display:none;" />
        <div id="wiz-loading" class="hidden mt-8 text-center text-primary font-bold animate-pulse">Analysiere...</div>
    </section>

    <section id="screen-wiz-verify" class="screen p-6 justify-center items-center text-center">
        <div class="size-20 rounded-full bg-primary/20 flex items-center justify-center mb-6 animate-bounce">
            <span class="material-symbols-outlined text-primary text-4xl">check</span>
        </div>
        <h2 class="text-2xl font-bold mb-2">Erfolgreich!</h2>
        <p id="wiz-result-text" class="text-gray-400 mb-8 font-mono text-sm bg-surface-dark p-2 rounded">...</p>
        <button onclick="confirmWizardStep()" class="w-full max-w-sm py-4 bg-primary text-background-dark font-bold rounded-xl">Weiter</button>
    </section>

    <section id="screen-home" class="screen bg-background-dark">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold">Hallo Alex,</h2>
                    <p class="text-xs text-gray-400">Bereit für die Challenge?</p>
                </div>
            </div>

            <div class="bg-surface-dark rounded-2xl p-6 border border-primary/20 relative overflow-hidden mb-8 shadow-lg">
                <h3 class="text-lg font-bold mb-1 text-primary">Level 1: Balance (Survival)</h3>
                <p class="text-sm text-gray-400 mb-6">Ziel: 30s stillhalten • Max 3 Fehler</p>
                <button onclick="startTrainingFlow()" class="relative z-10 w-full py-4 bg-primary text-background-dark font-bold rounded-xl flex items-center justify-center gap-2 hover:brightness-110">
                    <span class="material-symbols-outlined">play_arrow</span> Starten
                </button>
            </div>
            
            <h3 class="font-bold mb-3 text-sm text-gray-500 uppercase tracking-wider">Modus Auswahl</h3>
            <div class="flex flex-col gap-3">
                 <button onclick="setLevel(1)" class="p-4 bg-surface-dark rounded-xl border border-white/5 flex justify-between items-center hover:border-primary transition">
                    <div class="text-left"><span class="block font-bold">1. Balance (Zeit)</span><span class="text-xs text-gray-500">30s halten, Schusslinie</span></div>
                    <span class="material-symbols-outlined text-gray-600">timer</span>
                 </button>
                 <button onclick="setLevel(2)" class="p-4 bg-surface-dark rounded-xl border border-white/5 flex justify-between items-center hover:border-primary transition">
                    <div class="text-left"><span class="block font-bold">2. Arm Höhe (Reps)</span><span class="text-xs text-gray-500">5 Wiederholungen, Frontal</span></div>
                    <span class="material-symbols-outlined text-gray-600">fitness_center</span>
                 </button>
            </div>
        </div>
    </section>

    <section id="screen-safety" class="screen p-6 justify-center items-center text-center bg-red-900/10">
        <span class="material-symbols-outlined text-error text-6xl mb-4">gpp_maybe</span>
        <h2 class="text-2xl font-bold text-white mb-2">Sicherheitshinweis</h2>
        <div class="bg-surface-dark p-6 rounded-xl border border-error/30 mb-8 max-w-sm text-left shadow-xl">
            <p class="text-gray-300 leading-relaxed">⚠️ <strong>Niemals ohne Pfeil lösen.</strong><br><br>Nutze ein <strong>Theraband</strong> oder übe nur den Auszug.</p>
        </div>
        <button onclick="confirmSafety()" class="w-full max-w-sm py-4 bg-white text-black font-bold rounded-xl hover:bg-gray-200">Verstanden</button>
    </section>

    <section id="screen-live" class="screen bg-black">
        <div class="camera-wrapper">
            <video class="input_video" playsinline autoplay muted></video>
            <canvas class="output_canvas"></canvas>
            
            <div class="absolute top-0 left-0 w-full p-4 pt-6 flex justify-between items-start bg-gradient-to-b from-black/90 to-transparent z-20">
                <div>
                    <div id="counter-label" class="text-[10px] tracking-widest text-gray-400 uppercase">ZEIT</div>
                    <div class="text-5xl font-mono font-bold text-white tracking-tighter" id="main-counter">30<span class="text-2xl text-gray-600 font-normal">s</span></div>
                </div>
                
                <div class="flex flex-col items-end gap-3">
                    <div class="px-3 py-1 bg-surface-dark/80 border border-primary/50 text-primary text-xs font-bold rounded-full flex items-center gap-2 backdrop-blur">
                        <span class="material-symbols-outlined text-sm">visibility</span><span id="focus-text">BALANCE</span>
                    </div>
                    
                    <div id="strikes-container" class="flex gap-1 hidden">
                        <div id="strike-1" class="size-3 rounded-full bg-gray-600"></div>
                        <div id="strike-2" class="size-3 rounded-full bg-gray-600"></div>
                        <div id="strike-3" class="size-3 rounded-full bg-gray-600"></div>
                    </div>

                    <button onclick="stopTraining()" class="size-10 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-red-500/80 transition"><span class="material-symbols-outlined">close</span></button>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 w-full p-6 pb-8 bg-gradient-to-t from-black/90 to-transparent text-center z-20">
                <button onclick="startCameraStream()" class="text-[10px] text-gray-600 uppercase mb-2">Kamera Neustart</button>
                <div id="debug-text" class="text-sm text-gray-300 mb-2 font-mono pulse-text">Analyse läuft...</div>
                
                <div id="bar-container" class="w-full h-3 bg-gray-800 rounded-full overflow-hidden border border-white/10 transition-opacity">
                    <div id="prox-bar" class="h-full bg-primary w-0 transition-all duration-200 ease-out shadow-[0_0_10px_#74b814]"></div>
                </div>
            </div>
        </div>
    </section>

    <section id="screen-summary" class="screen p-6 justify-center items-center text-center">
        <div id="summary-icon-bg" class="size-32 rounded-full border-4 border-primary flex items-center justify-center mb-6 relative shadow-[0_0_20px_rgba(116,184,20,0.3)]">
            <span id="summary-icon" class="material-symbols-outlined text-6xl text-primary">emoji_events</span>
        </div>
        <h2 id="summary-title" class="text-3xl font-bold mb-2">Geschafft!</h2>
        <p id="summary-text" class="text-gray-400 mb-10 max-w-xs">Du hast 30 Sekunden durchgehalten.</p>
        <button onclick="showScreen('home')" class="w-full max-w-sm py-4 bg-surface-dark text-white font-bold rounded-xl border border-white/10">Zurück zum Dashboard</button>
    </section>

    <script>
// --- CONFIG ---
        const EXERCISES = {
            1: { 
                name: "Balance", 
                focus: "KOPF STILL", 
                ref: "line", 
                type: "time", 
                duration: 30, 
                maxStrikes: 3 
            },
            2: { 
                name: "Arm", 
                focus: "ARM HÖHE", 
                ref: "chest", 
                type: "reps", 
                targetReps: 5 
            }
        };

        const appState = {
            calib: { line: null, chest: null },
            wizard: { step: 'line' }, 
            training: { 
                level: 1, 
                reps: 0, 
                timeLeft: 30, 
                strikes: 0, 
                isActive: false,
                lastErrorTime: 0 
            }
        };

        // --- DOM ---
        const $ = id => document.getElementById(id);
        const screens = document.querySelectorAll('.screen');
        const video = document.querySelector('.input_video');
        const canvas = document.querySelector('.output_canvas');
        const ctx = canvas.getContext('2d');
        
        // --- NAVIGATION ---
        function showScreen(id) {
            screens.forEach(s => s.classList.remove('active'));
            $(`screen-${id}`).classList.add('active');
        }

        // ... (Wizard Funktionen bleiben gleich wie V8) ...
        function startWizard() { initTTS(); appState.wizard.step = 'line'; updateWizardUI(); showScreen('wiz-intro'); }
        function updateWizardUI() {
            const isLine = appState.wizard.step === 'line';
            $('wiz-title').innerText = isLine ? "Schritt 1: Schusslinie" : "Schritt 2: Frontal (Bauch)";
            $('wiz-desc').innerText = isLine 
                ? "Stelle dich auf die Schusslinie. Wir messen deine Balance." 
                : "Dreh dich zur Kamera (90°). Wir messen deinen Armwinkel.";
            $('wiz-input').value = "";
        }
        function nextWizardStep(target) { showScreen(`wiz-${target}`); }
        function prevWizardStep() { showScreen('wiz-intro'); }
        function confirmWizardStep() {
            if(appState.wizard.step === 'line') {
                appState.wizard.step = 'chest';
                updateWizardUI();
                showScreen('wiz-intro');
            } else { showScreen('home'); }
        }

        // ... (Calibration Logic bleibt gleich wie V8) ...
        const poseStatic = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        poseStatic.setOptions({modelComplexity: 1});
        poseStatic.onResults(handleWizResults);
        $('wiz-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                $('wiz-loading').classList.remove('hidden');
                const img = $('wiz-img-proc');
                img.src = URL.createObjectURL(file);
                img.onload = () => poseStatic.send({image: img});
            }
        });
        function handleWizResults(results) {
            $('wiz-loading').classList.add('hidden');
            if(!results.poseLandmarks) { alert("Keine Person erkannt."); return; }
            const lm = results.poseLandmarks;
            if (appState.wizard.step === 'line') {
                const noseX = lm[0].x;
                const hipX = (lm[23].x + lm[24].x) / 2;
                const bodyH = Math.abs(lm[11].y - lm[23].y);
                appState.calib.line = { leanRef: (noseX - hipX) / (bodyH || 1) };
                $('wiz-result-text').innerText = "Balance gespeichert.";
            } else {
                appState.calib.chest = { bowArm: calculateAngle(lm[11], lm[13], lm[15]) };
                $('wiz-result-text').innerText = "Armwinkel gespeichert.";
            }
            showScreen('wiz-verify');
        }

        // --- TRAINING FLOW ---
        function startTrainingFlow() { showScreen('safety'); speak("Sicherheit beachten."); }
        function setLevel(lvl) { appState.training.level = lvl; startTrainingFlow(); }
        function confirmSafety() { showScreen('live'); startLiveSession(); }
        
        function stopTraining() { 
            appState.training.isActive = false; 
            stopAudio(); 
            showScreen('home'); 
        }

        function finishLevel(success) {
            // WICHTIG: isActive NICHT auf false setzen, damit Video weiterläuft!
            // Wir stoppen nur die Logik-Auswertung.
            stopAudio(); 
            
            if(success) {
                playSuccess();
                speak("Übung geschafft.");
                $('summary-title').innerText = "Geschafft!";
                $('summary-title').className = "text-3xl font-bold mb-2 text-primary";
                $('summary-icon').innerText = "emoji_events";
                $('summary-icon-bg').className = "size-32 rounded-full border-4 border-primary flex items-center justify-center mb-6 relative shadow-[0_0_20px_rgba(116,184,20,0.3)]";
                $('summary-text').innerText = "Du hast die Position stabil gehalten.";
            } else {
                playError(); 
                speak("Leider nicht geschafft.");
                $('summary-title').innerText = "Versuch's nochmal";
                $('summary-title').className = "text-3xl font-bold mb-2 text-error";
                $('summary-icon').innerText = "replay";
                $('summary-icon-bg').className = "size-32 rounded-full border-4 border-error flex items-center justify-center mb-6 relative shadow-[0_0_20px_rgba(239,68,68,0.3)]";
                $('summary-text').innerText = "Zu viele Wackler. Achte auf deine Balance.";
            }
            
            // Zeige Summary als Overlay, aber lass Live-View drunter
            // Wir "pausieren" nur die Logik
            appState.training.isActive = false; 
            // Video Loop läuft weiter, aber sendet keine Daten mehr an Logic
            
            showScreen('summary');
        }

        // --- LIVE CAMERA ---
        const poseLive = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        poseLive.setOptions({modelComplexity: 1, smoothLandmarks: true});
        poseLive.onResults(onLiveResults);

        async function startLiveSession() {
            appState.training.isActive = true;
            const ex = EXERCISES[appState.training.level];
            
            if (ex.type === 'time') {
                appState.training.timeLeft = ex.duration;
                appState.training.strikes = 0;
                $('counter-label').innerText = "ZEIT (HALTEN)";
                $('strikes-container').classList.remove('hidden');
                updateStrikesUI();
                // Timer wird jetzt in handleLogic gesteuert!
            } else {
                appState.training.reps = 0;
                $('counter-label').innerText = "REPS";
                $('strikes-container').classList.add('hidden');
            }
            
            appState.training.lastErrorTime = 0;
            updateUI();
            
            $('focus-text').innerText = ex.focus;
            speak(`Fokus: ${ex.focus}`);
            
            initAudio();
            startCameraStream();
        }

        function updateUI() {
            const ex = EXERCISES[appState.training.level];
            if (ex.type === 'time') {
                $('main-counter').innerHTML = `${Math.ceil(appState.training.timeLeft)}<span class="text-2xl text-gray-600 font-normal">s</span>`;
            } else {
                $('main-counter').innerHTML = `${appState.training.reps}<span class="text-2xl text-gray-600 font-normal">/5</span>`;
            }
        }

        function updateStrikesUI() {
            ['strike-1', 'strike-2', 'strike-3'].forEach(id => $(id).className = "size-3 rounded-full bg-gray-600");
            for(let i=0; i<appState.training.strikes; i++) {
                if(i < 3) $(`strike-${i+1}`).className = "size-3 rounded-full bg-error shadow-[0_0_5px_red]";
            }
        }

        async function startCameraStream() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }, audio: false 
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => { video.play(); processLoop(); };
            } catch(e) { alert("Kamera Fehler."); }
        }

        async function processLoop() {
            // Der Loop läuft IMMER, auch wenn isActive false ist (für Hintergrund)
            // Aber wir senden nur an MediaPipe wenn aktiv oder wir Hintergrund wollen
            if(video.readyState >= 2) {
                // Sende immer für Visuals, aber Logik stoppen wir intern
                await poseLive.send({image: video});
            }
            if($('screen-live').classList.contains('active')) {
                 requestAnimationFrame(processLoop);
            }
        }

        function onLiveResults(results) {
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            
            if(results.poseLandmarks) {
                // Zeichnen immer (damit kein "Freeze" Gefühl entsteht)
                drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#000000', lineWidth: 6});
                drawLandmarks(ctx, results.poseLandmarks, {color: '#000000', lineWidth: 6});
                drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#74b814', lineWidth: 3});
                drawLandmarks(ctx, results.poseLandmarks, {color: '#FFFFFF', lineWidth: 2});
                
                // Logik nur wenn Training aktiv
                if(appState.training.isActive) {
                    evaluatePose(results.poseLandmarks);
                }
            }
        }

        function evaluatePose(lm) {
            const ex = EXERCISES[appState.training.level];
            let isGood = false;
            let tolerance = 0.1;
            let diff = 0;

            if (ex.ref === 'line' && appState.calib.line) {
                // BALANCE
                const noseX = lm[0].x;
                const hipX = (lm[23].x + lm[24].x) / 2;
                const bodyH = Math.abs(lm[11].y - lm[23].y);
                const currentLean = (noseX - hipX) / (bodyH || 1);
                diff = Math.abs(currentLean - appState.calib.line.leanRef);
                tolerance = 0.08; 
                isGood = diff < tolerance;

            } else if (ex.ref === 'chest' && appState.calib.chest) {
                // ARM
                const cur = calculateAngle(lm[11], lm[13], lm[15]);
                diff = Math.abs(cur - appState.calib.chest.bowArm);
                tolerance = 15;
                isGood = diff < tolerance;
            }

            if(ex.type === 'time') {
                handleTimeLogic(isGood);
            } else {
                handleRepLogic(isGood, diff);
            }
        }

        // --- NEW TIME LOGIC (SMART TIMER) ---
        let lastTimeCheck = 0;
        
        function handleTimeLogic(isGood) {
            const now = Date.now();
            
            if(!drone) initAudio();

            if(isGood) {
                // Haltung GUT -> Timer läuft
                drone.volume.rampTo(-15, 0.1); // Leises Hintergrund-Summen
                $('debug-text').innerText = "Haltung gut - Zeit läuft";
                $('debug-text').className = "text-sm text-green-400 mb-2 font-mono";
                $('prox-bar').className = "h-full bg-primary transition-all";
                $('prox-bar').style.width = "100%";

                // Timer abziehen (Delta Time)
                if(lastTimeCheck === 0) lastTimeCheck = now;
                const delta = (now - lastTimeCheck) / 1000;
                
                if(delta > 0.1) { // Nur updaten alle 100ms
                    appState.training.timeLeft -= delta;
                    updateUI();
                    lastTimeCheck = now;
                }

                if(appState.training.timeLeft <= 0) {
                    finishLevel(true);
                }

            } else {
                // Haltung SCHLECHT -> Timer PAUSIERT
                lastTimeCheck = 0; // Reset Delta
                
                drone.volume.rampTo(-10, 0.1); // Etwas lauter als Warnung
                $('debug-text').innerText = "STOPP - Korrigieren!";
                $('debug-text').className = "text-sm text-error mb-2 font-bold font-mono animate-pulse";
                $('prox-bar').className = "h-full bg-error shadow-[0_0_10px_red] transition-all";
                $('prox-bar').style.width = "100%";
                
                // Fehler zählen
                if (now - appState.training.lastErrorTime > 2000) { 
                    playError();
                    appState.training.strikes++;
                    appState.training.lastErrorTime = now;
                    updateStrikesUI();
                    
                    if(appState.training.strikes >= EXERCISES[1].maxStrikes) {
                        finishLevel(false);
                    }
                }
            }
        }

        function handleRepLogic(isGood, diff) {
             const proximity = Math.max(0, 1 - (diff / 45));
             $('prox-bar').style.width = `${proximity * 100}%`;
             
             if(isGood) {
                 $('prox-bar').className = "h-full bg-primary transition-all";
                 if(appState.training.holdingSince === 0) appState.training.holdingSince = Date.now();
                 
                 if(Date.now() - appState.training.holdingSince > 500) {
                     if(Date.now() - (window.lastSuccess||0) > 2000) {
                         playSuccess();
                         window.lastSuccess = Date.now();
                         appState.training.reps++;
                         updateUI();
                         speak(String(appState.training.reps));
                         if(appState.training.reps >= 5) setTimeout(() => finishLevel(true), 1000);
                     }
                 }
             } else {
                 $('prox-bar').className = "h-full bg-error transition-all";
                 appState.training.holdingSince = 0;
             }
        }

        // --- AUDIO ENGINE V4 (Pleasant Drone) ---
        let drone, membrane, polySynth, filter;

        function initAudio() {
            if(drone) return;
            Tone.start();
            
            // Filter für weicheren Sound (LowPass)
            filter = new Tone.Filter(200, "lowpass").toDestination();
            
            // Drone: PulseWave klingt technischer aber weicher als Sawtooth
            drone = new Tone.PulseOscillator(50, 0.4).connect(filter); 
            drone.volume.value = -Infinity; 
            drone.start();
            drone.volume.rampTo(-15, 2); // Slow Fade In

            membrane = new Tone.MembraneSynth().toDestination();
            membrane.volume.value = -2; 

            polySynth = new Tone.PolySynth(Tone.Synth).toDestination();
            polySynth.volume.value = -5;
        }

        function stopAudio() {
            if(drone) drone.volume.rampTo(-Infinity, 1);
        }

        function playError() { if(membrane) membrane.triggerAttackRelease("C1", "8n"); }
        function playSuccess() { if(polySynth) polySynth.triggerAttackRelease(["C5", "E5", "G5"], "8n"); }

        // --- HELPERS ---
        function initTTS() { if ('speechSynthesis' in window) window.speechSynthesis.getVoices(); }
        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'de-DE'; u.rate = 1.1;
                const v = window.speechSynthesis.getVoices().find(v => v.lang.includes('de'));
                if(v) u.voice = v;
                window.speechSynthesis.speak(u);
            }
        }
        function calculateAngle(a, b, c) {
            let rad = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(rad * (180.0 / Math.PI));
            if (angle > 180.0) angle = 360 - angle;
            return angle;
        }
        document.addEventListener('keydown', e => { if(e.key === 's') appState.training.reps++; });    </script>
</body>
</html>